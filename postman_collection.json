{
  "info": {
    "name": "Medical OCR Service - API-First v6",
    "_postman_id": "medical-ocr-api-first-v6",
    "description": "Coleccion completa de la API del Medical OCR Service con arquitectura API-First.\n\nFlujo recomendado:\n1. Login o usar API Key\n2. Cargar datos maestros (prestadores, nomencladores, acuerdos)\n3. Enviar ordenes medicas\n4. Recibir resultados via webhook\n5. Enviar feedback",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "base_url", "value": "http://localhost:3000" },
    { "key": "token", "value": "" },
    { "key": "refresh_token", "value": "" },
    { "key": "api_key", "value": "" },
    { "key": "tenant_id", "value": "" },
    { "key": "batch_id", "value": "" },
    { "key": "job_id", "value": "" },
    { "key": "visacion_id", "value": "" }
  ],
  "item": [
    {
      "name": "Health & Info",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/health"
          }
        },
        {
          "name": "Health Metrics",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/health/metrics"
          }
        },
        {
          "name": "Service Info",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/"
          }
        },
        {
          "name": "API Version",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/version"
          }
        }
      ]
    },
    {
      "name": "Authentication",
      "item": [
        {
          "name": "Register",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/auth/register",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@empresa.com\",\n  \"password\": \"Admin123!\",\n  \"name\": \"Administrador\",\n  \"role\": \"admin\"\n}"
            }
          }
        },
        {
          "name": "Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "  var json = pm.response.json();",
                  "  if (json.data && json.data.token) {",
                  "    pm.collectionVariables.set('token', json.data.token);",
                  "  }",
                  "  if (json.data && json.data.refreshToken) {",
                  "    pm.collectionVariables.set('refresh_token', json.data.refreshToken);",
                  "  }",
                  "  if (json.data && json.data.user && json.data.user.tenant_id) {",
                  "    pm.collectionVariables.set('tenant_id', json.data.user.tenant_id);",
                  "  }",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/auth/login",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@empresa.com\",\n  \"password\": \"Admin123!\"\n}"
            }
          }
        },
        {
          "name": "Refresh Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "  var json = pm.response.json();",
                  "  if (json.data && json.data.token) {",
                  "    pm.collectionVariables.set('token', json.data.token);",
                  "  }",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/auth/refresh",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refreshToken\": \"{{refresh_token}}\"\n}"
            }
          }
        },
        {
          "name": "My Profile",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "My Permissions",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/auth/permissions",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Data Ingestion",
      "description": "Endpoints de ingesta batch de datos maestros. Usan UPSERT via id_externo.",
      "item": [
        {
          "name": "Batch Prestadores",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 202) {",
                  "  var json = pm.response.json();",
                  "  pm.collectionVariables.set('job_id', json.job_id);",
                  "  pm.collectionVariables.set('batch_id', json.batch_id);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/data/prestadores/batch",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"source_ref\": \"SYNC_2024_01\",\n  \"prestadores\": [\n    {\n      \"id_externo\": \"PREST-001\",\n      \"ruc\": \"80012345-6\",\n      \"nombre_fantasia\": \"Sanatorio Americano\",\n      \"razon_social\": \"Sanatorio Americano S.A.\",\n      \"registro_profesional\": \"REG-12345\",\n      \"tipo\": \"SANATORIO\",\n      \"ranking\": 95.5,\n      \"estado\": \"ACTIVO\"\n    },\n    {\n      \"id_externo\": \"PREST-002\",\n      \"ruc\": \"80098765-4\",\n      \"nombre_fantasia\": \"Dr. Juan Martinez\",\n      \"razon_social\": \"Juan Martinez\",\n      \"registro_profesional\": \"MAT-54321\",\n      \"tipo\": \"MEDICO\",\n      \"ranking\": 88.0,\n      \"estado\": \"ACTIVO\"\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "Batch Nomencladores",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 202) {",
                  "  var json = pm.response.json();",
                  "  pm.collectionVariables.set('job_id', json.job_id);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/data/nomencladores/batch",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"source_ref\": \"SYNC_2024_01\",\n  \"nomencladores\": [\n    {\n      \"id_externo\": \"NOM-001\",\n      \"id_servicio\": 10,\n      \"especialidad\": \"LABORATORIO\",\n      \"descripcion\": \"Hemograma completo\",\n      \"desc_nomenclador\": \"Hemograma completo con recuento diferencial de leucocitos\",\n      \"grupo\": \"A\",\n      \"subgrupo\": \"A1\",\n      \"sinonimos\": [\"CBC\", \"biometria hematica\", \"cuadro hematico\"],\n      \"palabras_clave\": [\"sangre\", \"hematologia\", \"leucocitos\"],\n      \"estado\": \"ACTIVO\"\n    },\n    {\n      \"id_externo\": \"NOM-002\",\n      \"id_servicio\": 20,\n      \"especialidad\": \"IMAGENOLOGIA\",\n      \"descripcion\": \"Radiografia de torax frente y perfil\",\n      \"desc_nomenclador\": \"Radiografia de torax PA y lateral\",\n      \"grupo\": \"B\",\n      \"subgrupo\": \"B1\",\n      \"sinonimos\": [\"RX torax\", \"placa de torax\", \"chest X-ray\"],\n      \"palabras_clave\": [\"torax\", \"pulmon\", \"radiografia\"],\n      \"estado\": \"ACTIVO\"\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "Batch Acuerdos",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/data/acuerdos/batch",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"source_ref\": \"SYNC_2024_01\",\n  \"acuerdos\": [\n    {\n      \"id_prestador_externo\": \"PREST-001\",\n      \"id_nomenclador_externo\": \"NOM-001\",\n      \"plan_id\": 1,\n      \"precio\": 150000,\n      \"precio_normal\": 150000,\n      \"precio_diferenciado\": 120000,\n      \"precio_internado\": 100000,\n      \"vigente\": \"SI\",\n      \"fecha_vigencia\": \"2024-01-01\"\n    },\n    {\n      \"id_prestador_externo\": \"PREST-001\",\n      \"id_nomenclador_externo\": \"NOM-002\",\n      \"plan_id\": 1,\n      \"precio\": 250000,\n      \"precio_normal\": 250000,\n      \"vigente\": \"SI\"\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "Job Status",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/data/jobs/{{job_id}}/status",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Database Stats",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/data/stats",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Order Processing",
      "description": "Envio de ordenes medicas para OCR y pre-visacion asincrona.",
      "item": [
        {
          "name": "Batch Ordenes",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 202) {",
                  "  var json = pm.response.json();",
                  "  pm.collectionVariables.set('batch_id', json.batch_id);",
                  "  if (json.jobs && json.jobs.length > 0) {",
                  "    pm.collectionVariables.set('job_id', json.jobs[0].job_id);",
                  "  }",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/ordenes/batch",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"ordenes\": [\n    {\n      \"id_externo\": \"ORD-2024-00001\",\n      \"archivo_base64\": \"/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAP//\",\n      \"archivo_nombre\": \"orden_medica_001.jpg\",\n      \"archivo_tipo\": \"image/jpeg\",\n      \"metadata\": {\n        \"plan_id\": 1,\n        \"ci_paciente\": \"4567890\",\n        \"prioridad\": \"NORMAL\"\n      }\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "Batch Status",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/ordenes/batch/{{batch_id}}/status",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Feedback",
      "description": "Aprobar, rechazar o corregir pre-visaciones.",
      "item": [
        {
          "name": "Aprobar Pre-visacion",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/ordenes/{{visacion_id}}/feedback",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"accion\": \"APROBAR\",\n  \"usuario\": \"dr.martinez\"\n}"
            }
          }
        },
        {
          "name": "Rechazar Pre-visacion",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/ordenes/{{visacion_id}}/feedback",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"accion\": \"RECHAZAR\",\n  \"usuario\": \"dr.martinez\",\n  \"motivo\": \"Orden ilegible, solicitar nueva imagen\"\n}"
            }
          }
        },
        {
          "name": "Corregir Pre-visacion",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/ordenes/{{visacion_id}}/feedback",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"accion\": \"CORREGIR\",\n  \"usuario\": \"dr.martinez\",\n  \"motivo\": \"Nomenclador incorrecto en item 2\",\n  \"correcciones\": [\n    {\n      \"item\": 2,\n      \"id_nomenclador_correcto\": 456,\n      \"cantidad_correcta\": 2,\n      \"razon\": \"Es ecografia abdominal, no ecografia renal\"\n    }\n  ]\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Webhooks Management",
      "description": "CRUD de configuracion de webhooks por tenant.",
      "item": [
        {
          "name": "List Webhooks",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/webhooks",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Create Webhook",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/webhooks",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"url\": \"https://tu-sistema.com/webhooks/medical-ocr\",\n  \"events\": [\"previsacion.generada\", \"previsacion.fallida\", \"previsacion.feedback_recibido\"],\n  \"secret\": \"mi-secreto-webhook-hmac\"\n}"
            }
          }
        },
        {
          "name": "Update Webhook",
          "request": {
            "method": "PUT",
            "url": "{{base_url}}/api/v1/webhooks/1",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"events\": [\"*\"],\n  \"status\": \"active\"\n}"
            }
          }
        },
        {
          "name": "Delete Webhook",
          "request": {
            "method": "DELETE",
            "url": "{{base_url}}/api/v1/webhooks/1",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Plans",
      "description": "Planes SaaS disponibles con sus limites.",
      "item": [
        {
          "name": "List Plans",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/plans",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Get Plan Details",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/plans/professional",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Tenants",
      "description": "Gestion de tenants (requiere super_admin). Todos los datos se filtran por tenant_id del JWT.",
      "item": [
        {
          "name": "List Tenants",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/tenants",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Create Tenant",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/tenants",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Hospital Central\",\n  \"slug\": \"hospital-central\",\n  \"plan\": \"professional\",\n  \"settings\": {\n    \"max_orders_month\": 5000,\n    \"max_api_keys\": 20,\n    \"max_users\": 50,\n    \"max_webhooks\": 10,\n    \"max_prestadores\": 10000,\n    \"max_nomencladores\": 20000\n  }\n}"
            }
          }
        },
        {
          "name": "Get Tenant",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/tenants/{{tenant_id}}",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Tenant Stats",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/tenants/stats",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Tenant Dashboard",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/tenants/dashboard",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Users",
      "item": [
        {
          "name": "List Users",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/users",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Create User",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/users",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"operador@empresa.com\",\n  \"password\": \"Operator123!\",\n  \"name\": \"Operador\",\n  \"role\": \"operator\"\n}"
            }
          }
        },
        {
          "name": "Get User",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/users/1",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Delete User",
          "request": {
            "method": "DELETE",
            "url": "{{base_url}}/api/v1/users/1",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "API Keys",
      "item": [
        {
          "name": "List API Keys",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/api-keys",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Create API Key",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "  var json = pm.response.json();",
                  "  if (json.data && json.data.key) {",
                  "    pm.collectionVariables.set('api_key', json.data.key);",
                  "  }",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/api-keys",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Integracion APEX\",\n  \"scopes\": [\"data:import\", \"orders:write\", \"orders:read\"],\n  \"expiresIn\": \"365d\"\n}"
            }
          }
        },
        {
          "name": "Delete API Key",
          "request": {
            "method": "DELETE",
            "url": "{{base_url}}/api/v1/api-keys/1",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Usage & Metrics",
      "item": [
        {
          "name": "Usage Logs",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/usage",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Usage Summary",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/usage/summary",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Daily Usage",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/usage/daily?days=7",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Quota",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/usage/quota",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Orders (Read)",
      "item": [
        {
          "name": "List Orders",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/orders",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Get Order",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/orders/1",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        },
        {
          "name": "Orders Stats",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/orders/stats",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ]
          }
        }
      ]
    },
    {
      "name": "Auth with API Key (example)",
      "description": "Ejemplo usando X-Api-Key en vez de Bearer JWT.",
      "item": [
        {
          "name": "Database Stats (API Key)",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/v1/data/stats",
            "header": [
              { "key": "X-Api-Key", "value": "{{api_key}}" }
            ]
          }
        },
        {
          "name": "Batch Prestadores (API Key)",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/api/v1/data/prestadores/batch",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "X-Api-Key", "value": "{{api_key}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"prestadores\": [\n    {\n      \"id_externo\": \"PREST-100\",\n      \"nombre_fantasia\": \"Laboratorio Central\",\n      \"tipo\": \"LABORATORIO\",\n      \"estado\": \"ACTIVO\"\n    }\n  ]\n}"
            }
          }
        }
      ]
    }
  ]
}
