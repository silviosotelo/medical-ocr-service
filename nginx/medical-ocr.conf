server {
    listen 80;
    server_name _;

    # --- Frontend SPA (React/Vite) ---
    # Archivos estáticos buildeados en /portal/
    location /portal/ {
        alias /var/www/medical-ocr-service/frontend/dist/;

        # SPA: cualquier ruta que no sea un archivo real → index.html
        try_files $uri $uri/ /portal/index.html;

        # Cache de assets con hash en el nombre (Vite los genera con hash)
        location ~* \.(?:js|css|woff2?|ttf|eot|svg|png|jpg|jpeg|gif|ico|webp)$ {
            alias /var/www/medical-ocr-service/frontend/dist/;
            try_files $uri =404;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # Redirect /portal (sin trailing slash) a /portal/
    location = /portal {
        return 301 /portal/;
    }

    # --- Backend API proxy ---
    location /api/ {
        proxy_pass http://127.0.0.1:13500;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts para requests largos (OCR processing)
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # Permitir uploads grandes (archivos médicos)
        client_max_body_size 20m;
    }

    # --- Health check proxy ---
    location /health {
        proxy_pass http://127.0.0.1:13500;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # --- Root redirect al portal ---
    location = / {
        return 301 /portal/;
    }
}
